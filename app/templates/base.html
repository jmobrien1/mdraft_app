<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}mdraft — convert to Markdown{% endblock %}</title>
  <meta name="description" content="mdraft converts your files to clean Markdown."/>
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml"/>
  <link rel="preload" href="/static/styles.css" as="style"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  {% block head %}{% endblock %}
</head>
<body>
  <div class="container">
    <div class="header">
      <a class="brand" href="/">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="1.5"/><path d="M8 13l2-2 2 2 4-4" stroke="currentColor" stroke-width="1.5"/></svg>
        <h1>mdraft</h1>
      </a>
      <div class="row">
        <a class="link" href="/health" title="health">/health</a>
        <a class="link" href="https://mdraft-web.onrender.com/api/conversions?limit=5" target="_blank">API</a>
        <span id="usage-badge" style="display:none; margin-left:8px; padding:2px 6px; border-radius:10px; background:#eef; color:#224; font-size:0.85rem;"></span>
      </div>
    </div>

    {% block content %}{% endblock %}

    <div class="section hint">mdraft beta · <span class="badge">v0</span></div>
  </div>
  <script type="module" src="/static/app.js"></script>
  <div class="toast" aria-live="polite"></div>
  {% block scripts %}{% endblock %}
  <script>
(function () {
  const el = document.getElementById('usage-badge');
  if (!el) return;
  const show = (txt, title) => { el.textContent = txt; if (title) el.title = title; el.style.display = 'inline-block'; };
  const hide = () => { el.style.display = 'none'; };
  async function loadUsage() {
    try {
      const res = await fetch('/api/me/usage', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (res.status === 401) { hide(); return; } // not logged in during F&F
      if (!res.ok || !ct.includes('application/json')) { hide(); return; }
      const data = await res.json();
      if (!data || typeof data.used_pages !== 'number' || typeof data.cap_pages !== 'number') { hide(); return; }
      const used = data.used_pages|0, cap = data.cap_pages|0, plan = (data.plan || '').trim() || 'F&F';
      show(`Usage: ${used}/${cap}`, `Plan: ${plan} • ${used} of ${cap} pages this month`);
    } catch (_) { hide(); }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadUsage);
  } else {
    loadUsage();
  }
  // Expose for manual refresh after a conversion completes:
  window.refreshUsageBadge = loadUsage;
})();
</script>
</body>
</html>
