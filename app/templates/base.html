<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}mdraft — convert to Markdown{% endblock %}</title>
  <meta name="description" content="mdraft converts your files to clean Markdown."/>
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml"/>
  <link rel="preload" href="/static/styles.css" as="style"/>
  <link rel="stylesheet" href="/static/styles.css"/>
  {% block head %}{% endblock %}
</head>
<body>
  <div class="container">
    <div class="header">
      <a class="brand" href="/">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="1.5"/><path d="M8 13l2-2 2 2 4-4" stroke="currentColor" stroke-width="1.5"/></svg>
        <h1>mdraft</h1>
      </a>
      <div class="row">
        <a class="link" href="/proposals" title="RFP Proposals">Proposals</a>
        <a class="link" href="/health" title="health">/health</a>
        <a class="link" href="https://mdraft-web.onrender.com/api/conversions?limit=5" target="_blank">API</a>
        {% if current_user.is_authenticated %}
          <span class="link">{{ current_user.email }}</span>
          <a class="link" href="{{ url_for('auth.logout') }}" title="Logout">Logout</a>
        {% else %}
          <a class="link" href="{{ url_for('auth.login') }}" title="Login">Login</a>
          <a class="link" href="{{ url_for('auth.register') }}" title="Register">Register</a>
        {% endif %}
        {% if config.BILLING_ENABLED %}
        <a class="link upgrade-btn" href="#" onclick="showUpgradeModal()" title="Upgrade to Pro">Upgrade</a>
        {% endif %}
        <span id="usage-badge" style="display:none; margin-left:8px; padding:2px 6px; border-radius:10px; background:#eef; color:#224; font-size:0.85rem;"></span>
      </div>
    </div>

    {% block content %}{% endblock %}

    <div class="section hint">mdraft beta · <span class="badge">v0</span></div>
  </div>
  <script type="module" src="/static/app.js"></script>
  <div class="toast" aria-live="polite"></div>
  
  {% if config.BILLING_ENABLED %}
  <!-- Upgrade Modal -->
  <div id="upgrade-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Upgrade to Pro</h2>
      <p>Get unlimited conversions and priority processing.</p>
      <button onclick="initiateCheckout()" class="upgrade-button">Upgrade Now</button>
    </div>
  </div>
  {% endif %}
  
  {% block scripts %}{% endblock %}
  <script>
(function () {
  const el = document.getElementById('usage-badge');
  if (!el) return;
  const show = (txt, title) => { el.textContent = txt; if (title) el.title = title; el.style.display = 'inline-block'; };
  const hide = () => { el.style.display = 'none'; };
      async function loadUsage() {
      try {
        const data = await api('/api/me/usage', { credentials: 'same-origin' });
        if (!data || typeof data.used_pages !== 'number' || typeof data.cap_pages !== 'number') { hide(); return; }
        const used = data.used_pages|0, cap = data.cap_pages|0, plan = (data.plan || '').trim() || 'F&F';
        show(`Usage: ${used}/${cap}`, `Plan: ${plan} • ${used} of ${cap} pages this month`);
      } catch (_) { hide(); }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadUsage);
  } else {
    loadUsage();
  }
  // Expose for manual refresh after a conversion completes:
  window.refreshUsageBadge = loadUsage;
})();

{% if config.BILLING_ENABLED %}
// Upgrade modal functionality
function showUpgradeModal() {
  document.getElementById('upgrade-modal').style.display = 'block';
}

function hideUpgradeModal() {
  document.getElementById('upgrade-modal').style.display = 'none';
}

async function initiateCheckout() {
  try {
    // TODO: Get current user ID from session
    const userId = 1; // Placeholder - should get from auth
    
    const response = await fetch('/billing/checkout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ user_id: userId })
    });
    
    const data = await response.json();
    
    if (response.ok && data.checkout_url) {
      window.location.href = data.checkout_url;
    } else {
      alert(data.message || 'Failed to create checkout session');
    }
  } catch (error) {
    console.error('Checkout error:', error);
    alert('Failed to initiate checkout');
  }
}

// Close modal when clicking outside or on X
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('upgrade-modal');
  const closeBtn = document.querySelector('.close');
  
  if (closeBtn) {
    closeBtn.onclick = hideUpgradeModal;
  }
  
  if (modal) {
    window.onclick = function(event) {
      if (event.target === modal) {
        hideUpgradeModal();
      }
    }
  }
});
  {% endif %}
</script>

<div id="ai-status" aria-live="polite" class="hidden"></div>

<style>
#ai-status { position: fixed; right: 16px; bottom: 16px; padding: 10px 12px; 
  background: rgba(0,0,0,.8); color:#fff; border-radius: 10px; 
  font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
  box-shadow: 0 6px 18px rgba(0,0,0,.25); max-width: 360px; z-index: 1000; }
#ai-status.hidden { display: none; }
#ai-status .spinner { display:inline-block; width:14px; height:14px; border:2px solid #fff; border-right-color: transparent; border-radius:50%; margin-right:8px; animation:spin .9s linear infinite; vertical-align:-2px;}
@keyframes spin{to{transform:rotate(360deg)}}
.btn-busy[disabled]{opacity:.6; cursor: wait;}
</style>

</body>
</html>
