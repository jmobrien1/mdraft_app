{% extends "base.html" %}
{% block title %}mdraft — upload & convert{% endblock %}
{% block content %}
  <div class="card">
    <h2>Upload to convert</h2>
    <p class="hint">Drop a file below or click to select. You'll get Markdown back. Async mode will queue and process via the worker.</p>
    <p class="hint">Optional: add <code>callback_url</code> to your API request to receive a POST when the conversion finishes. Verify with the <code>X-MDraft-Signature</code> header (HMAC SHA-256).</p>

    <form id="form" class="section">
      <div id="drop" class="drop">
        <input id="file" type="file" name="file" style="display:none" required />
        <div>📄 Drag & drop file here or <button class="btn secondary" type="button" id="pick">Choose file</button></div>
        <div id="chosen" class="hint" style="margin-top:6px;"></div>
      </div>
      <div id="estimate-line" style="margin-top:8px; font-size:0.9rem; color:#666;"></div>
      <div class="row" style="margin-top:12px;">
        <button id="btn" class="btn" type="submit">Convert</button>
        <span id="status" class="hint">Idle</span>
      </div>

    </form>
  </div>

  <div class="section card">
    <h2>Result</h2>
    <textarea id="out" class="ta mono" placeholder="Markdown will appear here..." readonly></textarea>
    <div class="row" style="margin-top:8px;">
      <button class="btn secondary" id="copyMd" type="button">Copy Markdown</button>
      <button class="btn secondary" id="dlMd" type="button">Download .md</button>
    </div>
  </div>

  <div class="section card" id="free-tools">
    <h2>Free Tools</h2>
    <div class="row" style="gap: 8px; margin-bottom: 12px;">
      <button class="btn secondary" id="compliance-matrix" type="button" disabled title="Upload an RFP first">Compliance Matrix</button>
      <button class="btn secondary" id="evaluation-criteria" type="button" disabled title="Upload an RFP first">Evaluation Criteria</button>
      <button class="btn secondary" id="annotated-outline" type="button" disabled title="Upload an RFP first">Annotated Outline</button>
      <button class="btn secondary" id="submission-checklist" type="button" disabled title="Upload an RFP first">Submission Checklist</button>
    </div>
    <pre id="free-tools-output" style="white-space:pre-wrap;overflow:auto;max-height:40vh;border:1px solid #ddd;padding:.75rem;border-radius:.5rem;background:#f9f9f9;margin:0;"></pre>
    <div id="outline-preview" style="margin-top:12px;"></div>
    <div class="row" style="margin-top:8px;">
      <button class="btn secondary" id="copyJson" type="button" disabled>Copy JSON</button>
      <button class="btn secondary" id="downloadCsv" type="button" disabled>Download CSV</button>
    </div>
  </div>

  <div class="section card">
    <div class="row" style="justify-content:space-between;">
      <h2>Recent conversions</h2>
      <span class="hint">latest 10</span>
    </div>
    <div id="recent">
      <div class="skel" style="width:70%"></div>
      <div class="skel" style="width:40%;margin-top:8px"></div>
      <div class="skel" style="width:55%;margin-top:8px"></div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script type="module">
  import {toast,copy,fmtDate,dragAndDrop} from "/static/app.js";
  const form = document.getElementById('form');
  const file = document.getElementById('file');
  const btn = document.getElementById('btn');
  const out = document.getElementById('out');
  const statusEl = document.getElementById('status');
  const pick = document.getElementById('pick');
  const drop = document.getElementById('drop');
  const chosen = document.getElementById('chosen');



  pick.addEventListener('click', ()=> file.click());
  dragAndDrop(file, drop);
  drop.addEventListener('click', (e)=>{ if(e.target===drop) file.click(); });
  file.addEventListener('change', ()=> chosen.textContent = file.files[0] ? file.files[0].name : "");

  // Free Tools functionality
  const freeToolsSection = document.getElementById('free-tools');
  const freeToolsButtons = ['compliance-matrix', 'evaluation-criteria', 'annotated-outline', 'submission-checklist'];
  const freeToolsOutput = document.getElementById('free-tools-output');
  const outlinePreview = document.getElementById('outline-preview');
  const copyJsonBtn = document.getElementById('copyJson');
  const downloadCsvBtn = document.getElementById('downloadCsv');

  // Store last document ID and JSON result globally
  window.lastDocumentId = null;
  window.lastJsonResult = null;
  
  // Initialize dev helper badge
  const badge = document.getElementById('docid-badge') || document.createElement('div');
  badge.id = 'docid-badge';
  badge.style.cssText = 'font-size:12px;color:#555;margin-top:.25rem;';
  badge.textContent = 'No document selected';
  (document.querySelector('#free-tools')||document.body).prepend(badge);

  function enableFreeTools(documentId) {
    window.lastDocumentId = documentId;
    freeToolsSection.style.display = 'block';
    freeToolsButtons.forEach(id => {
      const button = document.getElementById(id);
      button.disabled = false;
      button.title = ''; // Clear any tooltip
    });
    
    // Update badge
    const badge = document.getElementById('docid-badge');
    if (badge) {
      badge.textContent = `Document ID: ${documentId}`;
    }
  }

  function disableFreeTools() {
    window.lastDocumentId = null;
    window.lastJsonResult = null;
    freeToolsSection.style.display = 'block'; // Keep visible but with disabled buttons
    freeToolsButtons.forEach(id => {
      const button = document.getElementById(id);
      button.disabled = true;
      button.title = 'Upload an RFP first'; // Add tooltip for disabled state
    });
    copyJsonBtn.disabled = true;
    downloadCsvBtn.disabled = true;
    freeToolsOutput.textContent = '';
    outlinePreview.innerHTML = '';
    
    // Update badge
    const badge = document.getElementById('docid-badge');
    if (badge) {
      badge.textContent = 'No document selected';
    }
  }

  // Non-blocking status UI helpers
  function showStatus(msg, busy = false) {
    const el = document.getElementById('ai-status');
    if (!el) return;
    el.innerHTML = busy ? `<span class="spinner"></span>${msg}` : msg;
    el.classList.toggle('hidden', !msg);
  }

  function withBusyButton(btn, busy) {
    if (!btn) return;
    btn.classList.toggle('btn-busy', busy);
    btn.disabled = !!busy;
    btn.setAttribute('aria-busy', busy ? 'true' : 'false');
  }

  async function apiPostJSON(url, body) {
    const headers = {'Content-Type':'application/json'};
    
    try {
      return await api(url, {
        method: 'POST',
        headers,
        body: JSON.stringify(body || {}),
        credentials: 'same-origin'
      });
    } catch (error) {
      throw { http: 500, text: error.message };
    }
  }

  async function runTool(btnSelector, url, body, onSuccess) {
    const btn = document.querySelector(btnSelector);
    showStatus('Working… this can take ~10–30s depending on RFP size.', true);
    withBusyButton(btn, true);

    try {
      const data = await apiPostJSON(url, body);
      // do not clear editor; hand results to a renderer panel
      if (typeof onSuccess === 'function') onSuccess(data);
      showStatus('Done.');
      setTimeout(() => showStatus('', false), 1600);
    } catch (err) {
      console.error('AI tool failed', err);
      let msg = 'Something went wrong.';
      if (err.json && err.json.error) {
        const { error, hint, detail } = err.json;
        msg = `${error}${hint ? ' — ' + hint : ''}${detail ? ' — ' + detail : ''}`;
      } else if (err.text) {
        msg = `${err.http || ''} ${err.text.slice(0,180)}`;
      }
      showStatus(msg, false);
    } finally {
      withBusyButton(btn, false);
    }
  }

  // Wire up buttons with non-blocking approach
  document.getElementById('compliance-matrix')?.addEventListener('click', () => {
    const docId = window.lastDocumentId;
    if (!docId) return;
    runTool('#compliance-matrix', '/api/generate/compliance-matrix', { document_id: docId }, (data) => {
      renderJsonToPanel('Compliance Matrix', data);
    });
  });

  document.getElementById('evaluation-criteria')?.addEventListener('click', () => {
    const docId = window.lastDocumentId;
    if (!docId) return;
    runTool('#evaluation-criteria', '/api/generate/evaluation-criteria', { document_id: docId }, (data) => {
      renderJsonToPanel('Evaluation Criteria', data);
    });
  });

  document.getElementById('annotated-outline')?.addEventListener('click', () => {
    const docId = window.lastDocumentId;
    if (!docId) return;
    runTool('#annotated-outline', '/api/generate/annotated-outline', { document_id: docId }, (data) => {
      renderJsonToPanel('Annotated Outline', data);
    });
  });

  document.getElementById('submission-checklist')?.addEventListener('click', () => {
    const docId = window.lastDocumentId;
    if (!docId) return;
    runTool('#submission-checklist', '/api/generate/submission-checklist', { document_id: docId }, (data) => {
      renderJsonToPanel('Submission Checklist', data);
    });
  });

  // Simple renderer that keeps main text intact
  function renderJsonToPanel(title, data) {
    window.lastJsonResult = data;
    freeToolsOutput.textContent = JSON.stringify(data, null, 2);
    copyJsonBtn.disabled = false;
    
    // Handle outline preview
    if (data.outline_markdown) {
      outlinePreview.innerHTML = `<h3>Outline Preview</h3><div style="border:1px solid #ddd;padding:.75rem;border-radius:.5rem;background:#fff;">${data.outline_markdown}</div>`;
    } else {
      outlinePreview.innerHTML = '';
    }
    
    // Enable CSV download if result is an array of objects
    downloadCsvBtn.disabled = !Array.isArray(data);
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

  // Copy JSON utility
  copyJsonBtn.addEventListener('click', () => {
    if (window.lastJsonResult) {
      copy(JSON.stringify(window.lastJsonResult, null, 2));
    }
  });

  // Download CSV utility
  downloadCsvBtn.addEventListener('click', () => {
    if (!Array.isArray(window.lastJsonResult) || window.lastJsonResult.length === 0) {
      toast('No array data to download', 2000);
      return;
    }
    
    try {
      const headers = Object.keys(window.lastJsonResult[0]);
      const csvContent = [
        headers.join(','),
        ...window.lastJsonResult.map(row => 
          headers.map(header => {
            const value = row[header];
            // Escape commas and quotes in CSV
            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
              return `"${value.replace(/"/g, '""')}"`;
            }
            return value || '';
          }).join(',')
        )
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'free-tools-result.csv';
      a.click();
      URL.revokeObjectURL(url);
      toast('CSV downloaded');
    } catch (err) {
      toast('CSV download failed', 2000);
    }
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!file.files.length) return;
    const fd = new FormData();
    fd.append('file', file.files[0]);
    btn.disabled = true; statusEl.textContent = 'Uploading…';

    try{
      const json = await api('/api/convert', { method: 'POST', body: fd, credentials: 'same-origin' });
      
      // Log upload response for debugging
      console.log('[mdraft] upload response:', json);
      
      // Accept any common key name for document ID
      window.lastDocumentId = json.id || json.document_id || json.doc_id || json.uuid || null;
      
      // Enable the four Free Tools buttons only if lastDocumentId is truthy
      const hasDocumentId = !!window.lastDocumentId;
      if (hasDocumentId) {
        enableFreeTools(window.lastDocumentId);
      } else {
        disableFreeTools();
      }
      

      
      const data = json;
      
      if (data.status === "QUEUED"){
        statusEl.textContent = 'Queued…';
        const poll = async ()=>{
          const j = await api(data.links.self);
          if (j.status === "COMPLETED"){
            statusEl.textContent = "Completed";
            out.value = await api(j.links.markdown);   // <-- always load markdown text
            
            // Log completion response and handle document ID robustly
            console.log('[mdraft] completion response:', j);
            const completionDocId = j.id || j.document_id || j.doc_id || j.uuid || null;
            if (completionDocId && completionDocId !== window.lastDocumentId) {
              window.lastDocumentId = completionDocId;
              enableFreeTools(completionDocId);
            }
            toast("Done"); await (window.loadRecent && window.loadRecent());
          } else if (j.status === "FAILED"){
            statusEl.textContent = "Failed";
            out.value = j.error || "conversion failed";
            disableFreeTools();
            toast("Failed", 2000);
          } else {
            setTimeout(poll, 1200);
          }
        }; poll();
      } else {
        statusEl.textContent = 'Done';
        if (data.markdown) {
          out.value = data.markdown;
        } else if (data.links && data.links.markdown) {
          out.value = await api(data.links.markdown);  // <-- fetch when only a link is returned
        } else {
          out.value = ""; // nothing? keep empty
        }
        toast("Done"); await (window.loadRecent && window.loadRecent());
      }
    }catch(err){
      statusEl.textContent = 'Network error'; out.value = String(err); disableFreeTools(); toast("Network error", 2000);
    }finally{
      btn.disabled = false; form.reset(); chosen.textContent="";
    }
  });

  document.getElementById('copyMd').onclick = ()=> navigator.clipboard.writeText(out.value||"");
  document.getElementById('dlMd').onclick = ()=>{
    const blob = new Blob([out.value||""], {type:"text/markdown"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='mdraft.md'; a.click(); URL.revokeObjectURL(url);
  };
</script>

<script>
// Load recent conversions (global so other scripts/HTML can call it)
window.loadRecent = async function loadRecent() {
  try {
    const data = await api('/api/conversions?limit=10', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
    // ⬇️ keep the existing DOM rendering for the recent list here, unchanged
    const el = document.getElementById('recent');
    el.innerHTML = '';
    (data.items||[]).forEach(item=>{
      const row = document.createElement('div'); row.className='item';
      const left = document.createElement('div');
      left.innerHTML = `<a class="link" href="${item.links.view||('/v/'+item.id)}" target="_blank">${item.filename}</a>
        <span class="badge">${item.status}</span>
        <span class="hint">${fmtDate(item.created_at)}</span>`;
      const right = document.createElement('div');
      const a1 = document.createElement('a'); a1.className='link'; a1.href=item.links.markdown; a1.textContent='Markdown'; a1.target='_blank';
      const a2 = document.createElement('a'); a2.className='link'; a2.href=item.links.view||('/v/'+item.id); a2.textContent='View'; a2.style.marginLeft='12px'; a2.target='_blank';
      const cp = document.createElement('button'); cp.className='btn secondary'; cp.style.marginLeft='12px'; cp.textContent='Copy link';
      cp.onclick=()=> copy(location.origin+(item.links.view||('/v/'+item.id)));
      const loadBtn = document.createElement('button');
      loadBtn.className = 'btn secondary';
      loadBtn.style.marginLeft = '12px';
      loadBtn.textContent = 'Load here';
      loadBtn.onclick = async ()=>{
        statusEl.textContent = 'Loading…';
        const m = await fetch(item.links.markdown);
        out.value = await m.text();
        
        // Set document ID when loading a previous conversion
        const docId = item.id || item.document_id || item.doc_id || item.uuid || null;
        if (docId) {
          window.lastDocumentId = docId;
          enableFreeTools(docId);
        } else {
          disableFreeTools();
        }
        
        statusEl.textContent = 'Loaded';
      };
      right.append(a1,a2,cp,loadBtn);
      row.append(left,right); el.append(row);
    });
  } catch (e) {
    console.warn('recent conversions fetch failed', e);
  }
};
// Auto-run on DOM ready, but keep function callable globally too
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => window.loadRecent());
} else {
  window.loadRecent();
}

window.loadRecent && window.loadRecent();
;(function () {
  const chooseBtn = document.getElementById('choose') || document.querySelector('[data-choose]');
  const fileInput = document.getElementById('file');
  if (chooseBtn && fileInput) {
    chooseBtn.addEventListener('click', (e) => { e.preventDefault(); fileInput.click(); });
  }
})();
</script>

<script>
(function () {
  const input = document.getElementById('file');
  const line  = document.getElementById('estimate-line');
  if (!input || !line) return;
  input.addEventListener('change', async () => {
    if (!input.files || !input.files[0]) { line.textContent = ''; return; }
    const file = input.files[0];
    line.textContent = 'Estimating…';
    try {
      const fd = new FormData();
      fd.append('file', file, file.name);
      const data = await api('/api/estimate', {
        method: 'POST',
        body: fd,
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin',
      });
      if (!data || typeof data.pages !== 'number') { line.textContent = 'Estimate unavailable.'; return; }
      line.textContent = `Estimate: ~${data.pages} premium pages → ~$${data.est_cost_usd} (not billed until run).`;
    } catch (err) {
      console.error('Estimate fetch failed', err);
      line.textContent = 'Estimate unavailable.';
    }
  });
})();
</script>
{% endblock %}
