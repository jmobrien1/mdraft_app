{% extends "base.html" %}
{% block title %}mdraft â€” upload & convert{% endblock %}
{% block content %}
  <div class="card">
    <h2>Upload to convert</h2>
    <p class="hint">Drop a file below or click to select. You'll get Markdown back. Async mode will queue and process via the worker.</p>

    <form id="form" class="section">
      <div id="drop" class="drop">
        <input id="file" type="file" name="file" style="display:none" required />
        <div>ðŸ“„ Drag & drop file here or <button class="btn secondary" type="button" id="pick">Choose file</button></div>
        <div id="chosen" class="hint" style="margin-top:6px;"></div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="btn" class="btn" type="submit">Convert</button>
        <span id="status" class="hint">Idle</span>
      </div>
    </form>
  </div>

  <div class="section card">
    <h2>Result</h2>
    <textarea id="out" class="ta mono" placeholder="Markdown will appear here..." readonly></textarea>
    <div class="row" style="margin-top:8px;">
      <button class="btn secondary" id="copyMd" type="button">Copy Markdown</button>
      <button class="btn secondary" id="dlMd" type="button">Download .md</button>
    </div>
  </div>

  <div class="section card">
    <div class="row" style="justify-content:space-between;">
      <h2>Recent conversions</h2>
      <span class="hint">latest 10</span>
    </div>
    <div id="recent">
      <div class="skel" style="width:70%"></div>
      <div class="skel" style="width:40%;margin-top:8px"></div>
      <div class="skel" style="width:55%;margin-top:8px"></div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script type="module">
  import {toast,copy,fmtDate,dragAndDrop} from "/static/app.js";
  const form = document.getElementById('form');
  const file = document.getElementById('file');
  const btn = document.getElementById('btn');
  const out = document.getElementById('out');
  const statusEl = document.getElementById('status');
  const pick = document.getElementById('pick');
  const drop = document.getElementById('drop');
  const chosen = document.getElementById('chosen');

  pick.addEventListener('click', ()=> file.click());
  dragAndDrop(file, drop);
  drop.addEventListener('click', (e)=>{ if(e.target===drop) file.click(); });
  file.addEventListener('change', ()=> chosen.textContent = file.files[0] ? file.files[0].name : "");

  async function loadRecent(){
    try{
      const res = await fetch('/api/conversions?limit=10');
      const data = await res.json();
      const el = document.getElementById('recent');
      el.innerHTML = '';
      (data.items||[]).forEach(item=>{
        const row = document.createElement('div'); row.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<a class="link" href="${item.links.view||('/v/'+item.id)}" target="_blank">${item.filename}</a>
          <span class="badge">${item.status}</span>
          <span class="hint">${fmtDate(item.created_at)}</span>`;
        const right = document.createElement('div');
        const a1 = document.createElement('a'); a1.className='link'; a1.href=item.links.markdown; a1.textContent='Markdown'; a1.target='_blank';
        const a2 = document.createElement('a'); a2.className='link'; a2.href=item.links.view||('/v/'+item.id); a2.textContent='View'; a2.style.marginLeft='12px'; a2.target='_blank';
        const cp = document.createElement('button'); cp.className='btn secondary'; cp.style.marginLeft='12px'; cp.textContent='Copy link';
        cp.onclick=()=> copy(location.origin+(item.links.view||('/v/'+item.id)));
        right.append(a1,a2,cp);
        row.append(left,right); el.append(row);
      });
    }catch(e){ console.error(e); }
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!file.files.length) return;
    const fd = new FormData();
    fd.append('file', file.files[0]);
    btn.disabled = true; statusEl.textContent = 'Uploadingâ€¦';

    try{
      const res = await fetch('/api/convert', { method: 'POST', body: fd });
      const data = await res.json();
      if (res.status === 202 && data.status === "QUEUED"){
        statusEl.textContent = 'Queuedâ€¦';
        const poll = async ()=>{
          const r = await fetch(data.links.self); const j = await r.json();
          if (j.status === "COMPLETED"){
            statusEl.textContent = "Completed";
            const m = await fetch(j.links.markdown); out.value = await m.text();
            toast("Done"); await loadRecent();
          }else if (j.status === "FAILED"){
            statusEl.textContent = "Failed"; out.value = j.error || "conversion failed";
            toast("Failed", 2000);
          }else{ setTimeout(poll, 1200); }
        }; poll();
      } else if (res.ok) {
        statusEl.textContent = 'Done';
        out.value = data.markdown ?? (data.links?.markdown ? ("See: "+data.links.markdown) : "");
        toast("Done"); await loadRecent();
      } else {
        statusEl.textContent = 'Error'; out.value = JSON.stringify(data);
        toast("Error", 2000);
      }
    }catch(err){
      statusEl.textContent = 'Network error'; out.value = String(err); toast("Network error", 2000);
    }finally{
      btn.disabled = false; form.reset(); chosen.textContent="";
    }
  });

  document.getElementById('copyMd').onclick = ()=> copy(out.value||"");
  document.getElementById('dlMd').onclick = ()=>{
    const blob = new Blob([out.value||""], {type:"text/markdown"}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='mdraft.md'; a.click(); URL.revokeObjectURL(url);
  };

  loadRecent();
</script>
{% endblock %}
